<properties
   pageTitle="資料分割指引 |Microsoft Azure"
   description="如何分割要個別管理和存取的分割區指引。"
   services=""
   documentationCenter="na"
   authors="dragon119"
   manager="masimms"
   editor=""
   tags=""/>

<tags
   ms.service="best-practice"
   ms.devlang="na"
   ms.topic="article"
   ms.tgt_pltfrm="na"
   ms.workload="na"
   ms.date="03/26/2016"
   ms.author="masashin"/>

# 資料分割指引

![](media/best-practices-data-partitioning/pnp-logo.png)

## 概觀

在許多大型解決方案中，資料分成個別的分割區，可以個別管理和存取。您必須仔細選擇資料分割策略，才能最大化利益，同時將不良影響降至最低。資料分割有助於改善延展性、減少爭用，以及最佳化效能。資料分割的另一項優點是可提供一種機制，藉由使用模式來區分資料。例如，您可以將較舊且較不使用 (冷) 的資料封存至成本較低的資料儲存體。

## 為何要分割資料？

大部分的雲端應用程式和服務會將資料儲存和擷取做為其作業的一部分。應用程式所使用之資料存放區的設計和系統的效能、輸送量和延展性有明顯的關係。通常會套用在大型系統中的一個技術是將資料區分成個別的分割區。

> 本指引中所用的「資料分割」一詞指的是實際將資料區分至個別資料存放區的程序。這和 SQL Server 資料表分割不同，後者是不同的概念。

分割資料可以提供許多優點。例如，它可以套用來：

- **改善延展性**。當您相應增加單一資料庫系統時，其最終將會到達實體硬體限制。如果您跨多個分割區來區分資料，而其中每一個分割區都裝載於個別伺服器上，您幾乎能夠無限制地相應放大系統。
- **提升效能**。在每個分割區上的資料存取作業會透過較小的資料磁碟區進行。假設資料是以適當方式來分割，則資料分割可讓您的系統更有效率。影響多個分割區的作業都能平行執行。每個分割區可以靠近使用它的應用程式以最小化網路延遲。
- **改善可用性**。跨多個伺服器分格資料可避免單一失敗點。如果伺服器失敗，或正在進行規劃的維護，只有該資料分割中的資料無法使用。在其他分割區上的作業可以繼續進行。增加分割區的數目可減少無法使用的資料百分比，藉以減少單一伺服器失敗的相對影響。複寫每個分割區可以進一步減少單一分割區失敗影響作業的機會。它也可以分離必須持續高度可用的重要資料和可用性需求較低的低價值資料 (例如記錄檔)。
- **改善安全性**。依據資料的性質及其分割方式，就可以將機密和非機密資料分離到不同的分割區，因而可分離到不同的伺服器或資料存放區。如此便可以為機密資料進行安全性的特別最佳化。
- **提供做業彈性**。資料分割提供許多微調作業、最大化系統管理效率和最小化成本的機會。例如，您可以根據資料在每個分割區中的重要性，來定義適用於管理、監視、備份和還原的不同原則，以及其他系統管理工作。
- **比對資料存放區和使用模式**。資料分割可根據資料存放區所提供的成本和內建功能，讓每個分割區部署在不同類型的資料存放區上。例如，大型二進位資料可儲存於 Blob 資料存放區，而更為結構化的資料可保存於文件資料庫中。如需詳細資訊，請參閱模式與實例指南中的 [Building a polyglot solution (建置 Polyglot 解決方案)] 和 Microsoft 網站上的 [Data Access for Highly-Scalable Solutions: Using SQL, NoSQL, and Polyglot Persistence (高度可調整解決方案的資料存取：使用 SQL、NoSQL 和 Polyglot 持續性)]。

有些系統不會實作資料分割，因為它會被視為成本，而不是一項優點。這個基本原理的常見原因包括：

- 許多資料儲存系統不支援跨分割區聯結，而且難以維護資料分割系統中的參考完整性。通常必須要實作應用程式碼中 (資料分割層中) 的聯結和完整性檢查，而這可能會導致其他 I/O 和應用程式的複雜度。
- 維護分割區不一定都是簡單的工作。在資料可變更的系統中，您可能需要定期重新平衡分割區來減少爭用和作用點。
- 常用的一些工具不會自然地使用分割的資料。

## 移除分割區

資料可以用不同的方式分割：水平、垂直或功能。您選擇的策略取決於分割資料的原因、應用程式的需求和使用該資料的服務。

> [AZURE.NOTE] 在本指引中所述之資料分割配置的說明方式與基礎的資料儲存技術無關。它們可以套用到許多類型的資料存放區，包括關聯式和 NoSQL 資料庫。

### 資料分割策略

分割資料的三個典型的策略是：

- **水平資料分割** (通常稱為_分區化_)。在此策略中，每個分割區本身都是資料存放區，但所有分割區具有相同的配置。每個分割區都稱為「分區」，而且會保存特定的資料子集，例如，電子商務應用程式中一組特定客戶的所有訂單。
- **垂直資料分割**。在此策略中，每個分割區會在資料存放區中保留項目的欄位子集。欄位會根據其使用模式來區分。比方說，經常存取的欄位可能會放在一個垂直的分割區中，而較不常存取的欄位則放置於另一個分割區中。
- **功能資料分割**。在此策略中，資料會根據系統中每個繫結的內容使用它的方式進行彙總。例如，實作發票開立和管理產品存貨等個別商務功能的電子商務系統可能會將發票資料儲存在某一個分割區中，並將產品庫存資料儲存於另一個。

請務必注意此處所述的三個策略可以結合。它們不會互斥，建議您在設計資料分割配置時應全部納入考量。例如，您可能會將資料區分成分區，然後使用垂直資料分割進一步細分每個分區中的資料。同樣地，功能分割區中的資料可劃分為分區 (也能以垂直方式分割)。

不過，每一種策略的不同需求可能會引發許多衝突問題。您在設計符合系統中整體資料處理效能目標的資料分割配置時，必須加以評估和平衡。下列各節會探索每一種策略的詳細資料。

### 水平資料分割 (分區化)

圖 1 顯示水平資料分割或分區化的概觀。在此範例中，產品庫存資料會根據產品索引鍵區分成分區。每個分區都保存分區索引鍵 (A-G 和 H-Z) 的連續範圍資料，依照字母順序排列。

![水平資料分割 (分區化) 的資料是以分割區索引鍵為基礎](media/best-practices-data-partitioning/DataPartitioning01.png)

_圖 1.水平資料分割 (分區化) 資料是以分割區索引鍵為基礎_

分區化可讓您將負載分散到多部電腦，以減少爭用並改善效能。您可以藉由新增在其他伺服器上執行的進一步分區，相應放大系統。

實作此資料分割策略時的最重要因素是分區化索引鍵的選擇。系統在作業之後，就很難變更索引鍵。索引鍵必須確定資料已分割，使工作負載盡可能跨分區平均分配。

請注意，不同的分區不一定會包含類似的資料磁碟區。而更重要的考量是平衡要求數目。有些分區可能非常大，但每個項目都是少量存取作業的主體。其他的分區可能比較小，但是更常存取每個項目。另一個重點是確保單一分區不會超過用來裝載該分區之資料存放區的規模限制 (以容量和處理資源為準)。

如果您使用分區化配置，請避免建立作用點 (或熱點分割區)，其會影響效能和可用性。例如，如果您使用客戶識別碼的雜湊，而不是客戶名稱的第一個字母，就能防止常見和較不常見首字母所產生的不平衡分佈。這是典型的技巧，有助於使資料更平均地跨分割區分佈。

選擇可最小化任何未來需求的分區化索引鍵，以將大型分區劃分成較小的片段、將小型分區聯合成較大的分割區，或者變更描述儲存在分割區集合中之資料的配置。這些作業非常耗時，而且可能需要在執行時讓一或多個分區離線。

如果複寫分區，某些複本可能要保持上線，而其他複本會被劃分、合併或重新設定。但在進行重新設定時，系統可能需要限制可在這些分區中的資料上執行的作業。例如，複本中的資料無法標記為唯讀以限制不一致的範圍，不一致的情形可能會在重新建構分區時發生。

> 如需這其中許多考量的詳細資訊和指引，以及設計實作水平資料分割的資料存放區之絕佳實務技術，請參閱 [Sharding Pattern (分區化模式)]。

### 垂直資料分割

垂直資料分割的最常見用途是可降低與擷取最常存取之項目相關聯的 I/O 和效能成本，。圖 2 顯示垂直資料分割的範例。在此範例中，每個資料項目的不同屬性都會保留於不同的分割區中。有一個分割區會保留較常存取的資料，包括產品的名稱、描述和價格資訊。另一個則會保留存貨量和上次訂購日期。

![以使用模式分割的垂直分割資料](media/best-practices-data-partitioning/DataPartitioning02.png)

_圖 2.依使用模式垂直分割資料_

在此範例中，應用程式會在向客戶顯示產品詳細資料時，固定查詢產品名稱、描述和價格。存貨量和上一次從製造商訂購產品的日期保留在不同的分割區，因為這兩個項目通常一起使用。

此資料分割配置會有額外的好處，移動頻率相當低的資料 (產品名稱、描述和價格) 會和較動態的資料 (存貨量和上一次訂單日期) 分開。如果移動頻率相當低的資料經常被存取，應用程式會發現在記憶體中快取該資料很有幫助。

另一個此資料分割策略的典型案例是最大化機密資料的安全性。例如，您可以藉由將信用卡號碼和對應的卡片安全性驗證號碼儲存在個別的分割區中，來達到此目的。

垂直資料分割也可以減少資料所需的並行存取數量。

> 垂直資料分割都是在資料存放區內的實體層級運做，有部分會正規化實體，將其從_廣泛_項目細分成一組_縮小_項目。在理想的情況下，它適用於 HBase 和 Cassandra 等資料行導向的資料存放區。如果資料行集合中的資料不太可能變更，您也可以考慮使用 SQL Server 中的資料行存放區。

### 功能資料分割

對於可以在應用程式中為每個不同的商業領域或服務識別繫結內容的系統，功能資料分割提供一種技術，可改善隔離和資料存取效能。功能資料分割的另一種常用功能是將讀寫資料與用於報告用途的唯讀資料分開。圖 3 顯示功能資料分割的概觀，清查資料可從客戶的資料分開。

![以繫結的內容或子網域分割的功能分割資料](media/best-practices-data-partitioning/DataPartitioning03.png)

_圖 3.依繫結的內容或子網域分割的功能分割資料_

此資料分割策略有助於減少跨系統的不同部分所發生的資料存取爭用。

## 設計延展性的分割區

請務必考慮每個分割區的大小和工作負載並加以平衡，使資料分佈以達到最大延展性。不過，您也必須分割資料，使它不會超過單一資料分割存放區的調整限制。

設計具延展性的分割區時，請遵循下列步驟：

1. 分析應用程式以了解資料存取模式，例如每個查詢所傳回的結果集大小、存取的頻率、固有的延遲，以及伺服器端計算處理需求。在許多情況下，幾個主要實體會要求大部分的處理資源。
2. 使用此分析來判斷目前和未來的延展性目標，例如資料大小和工作負載。然後將資料分散在各個分割區上，以符合延展性目標。在水平資料分割策略中，選擇適當的分區索引鍵，這對確定分佈是否平均很重要。如需詳細資訊，請參閱[分區化模式]。
3. 請確定每個分割區的可用資源充足，可處理資料大小和輸送量方面的延展性需求。例如，裝載於分割區的節點可能加諸固定限制的儲存空間量、處理能力或它提供的網路頻寬量。如果資料儲存體和處理需求可能超過這些限制，就可能需要調整您的資料分割策略或進一步劃分資料。例如，有一個延展性方法可能是與核心應用程式功能分開記錄資料。您可以使用個別的資料存放區，來防止資料儲存體需求總數超過節點的調整限制。如果資料存放區的總數超過節點限制，可能必須使用不同的儲存體節點。
4. 監視系統，以用來確認資料會如預期般分佈，而且分割區可以處理加諸其上的負載。使用量可能與分析所預期的使用量不符。在此情況下，可能需要重新平衡分割區。如果無法做到，可能就必須重新設計系統的某些部分，以取得必要的平衡。

請注意，某些雲端環境會根據基礎結構界限配置資源。您應該確定您所選界限的限制可在資料儲存體、處理能力及頻寬等方面，提供足夠的空間，使資料量能夠如預期般成長。

例如，如果您使用 Azure 表格儲存體，忙碌的分區所需的資源數可能超過可供單一分割區用來處理要求的資源數(單一分割區在指定期間內可處理的要求數量是有限制的 — 請參閱 Microsoft 網站上的 [Azure 儲存體延展性和效能目標]頁面，以取得詳細資料)。

 在此情況下，可能需要重新分割分區以散佈負載。如果這些表格的總大小或輸送量超過儲存體帳戶的容量，可能必須建立其他儲存體帳戶並跨這些帳戶散佈表格。如果儲存體帳戶的數目超過訂用帳戶可用的帳戶數目，則可能必須使用多個訂用帳戶。

## 設計查詢效能的分割區

使用較小的資料集和執行平行查詢，通常可提高查詢效能。每個分割區都應包含整個資料集的一小部分。數量的縮減可以改善查詢效能。不過，資料分割並不是適當地設計和設定資料庫的替代方式。例如，如果您使用關聯式資料庫，請確定您已備妥必要的索引。

基於查詢效能設計分割區時，請遵循下列步驟：

1. 檢查應用程式的需求以及效能：
	- 使用商務需求來判斷隨時必須快速執行的重要查詢。
	- 監視系統以識別任何執行速度慢的查詢。
	- 建立最常執行的查詢。每個查詢的單一執行個體可能會有最低的成本，但是資源的累計耗用量卻不少。它可能有助於將這些查詢所擷取的資料區分離到不同的分割區或甚至快取。
2. 分割會導致效能變慢的資料：
	- 限制每個分割區的大小，使查詢回應時間在目標內。
	- 設計分區索引鍵，在您實作水平資料分割時，讓應用程式可以輕鬆地找到分割區。這可防止查詢需要掃描每個分割區。
	- 請考慮分割區的位置。如果可能，請嘗試將資料保留在地理位置靠近存取它之應用程式和使用者的分割區。
3. 如果實體有輸送量和查詢效能的需求，請根據該實體使用功能資料分割。如果這樣還是無法滿足需求，請同時套用水平資料分割。在大部分情況下，單一資料分割策略就足夠了，但在某些情況下，結合這兩種策略會更有效率。
4. 請考慮使用跨分割區平行執行的非同步查詢，以改善效能。

## 設計可用性的分割區

分割資料可以確保整個資料集不會構成單一失敗點，而且確保資料集的個別子集可以分開管理，藉以改善應用程式的可用性。複寫包含重要資料的分割區，也能改善可用性。

設計和實作分割區時，請考慮下列會影響可用性的因素：

- **資料對商務營運的重要性**。某些資料可能包含重要商務資訊，例如發票明細或銀行交易。其他資料可能包含較不重要的營運資料，例如記錄檔、效能追蹤等等。識別每一個類型的資料之後，請考慮：
	- 利用適當的備份計劃，將重要資料儲存在高度可用的分割區中。
	- 為每個資料集的不同嚴重性建立個別的管理和監視機制或程序。將具有相同嚴重性等級的資料放在同一個分割區，利用適當的頻率一併進行備份。例如，保留銀行交易資料的分割區的備份頻率可能必須高於保留記錄或追蹤資訊的分割區。
- **個別分割區的管理方式**。將分割區設計為支援獨立管理和維護可提供數個優點。例如：
	- 如果分割區失敗，可以獨立復原而不會影響在其他分割區中存取資料的應用程式執行個體。
	- 依地理區域分割資料，允許已排程的維護工作在每個位置的離峰時段進行。請確定分割區不會太大而無法防止任何已規劃的分割區維護在這段期間完成。
- **是否要跨分割區複寫重要資料**。此策略可以改善可用性和效能，不過它也可以導入一致性問題。在分割區中對資料所做的變更，需要一段時間才能與每個複本同步。在這段期間，不同的分割區會包含不同的資料值。

## 了解資料分割會對設計與開發產生何種影響

如果您使用資料分割，就會增加系統設計和開發的複雜度。即使系統一開始只包含單一分割區，也請考慮將資料分割視為系統設計的基本部分。如果您在系統開始遭遇效能和延展性問題時，將資料分割當成備案來處理，就會增加複雜性，因為您已經有要維護的即時系統。

如果您更新系統以將資料分割納入此環境中，就需要修改資料存取邏輯。而它也會涉及移轉大量現有資料以跨分割區分佈資料，通常會在使用者期望能夠繼續使用系統時發生此情況。

在某些情況下，資料分割並不重要，因為初始資料集很小，而且可以輕鬆地由單一伺服器處理。對於不期待調整超出其初始大小的系統而言，這可能適用，但是許多商務系統都必須能夠在使用者數目增加時加以擴充。此擴充通常會伴隨資料量的成長。

同時，請務必了解資料分割不一定是大型資料存放區的功能。例如，數百個並行用戶端可能會大量存取一個小型資料存放區。在此情況下將資料分割可以協助減少爭用並提高輸送量。

當您設計資料分割配置時，應考慮下列幾點：

- **盡可能一併保留每個分割區中最常見資料庫作業的資料，以使跨分割區的資料存取作業減到最少**。跨分割區查詢可能比只在單一分割區內查詢更費時，但是最佳化一組查詢的分割區可能會對其他組的查詢造成不良影響。當您無法避免跨分割區查詢時，可以在應用程式內執行平行查詢並彙總結果，來將查詢時間降至最低。在某些情況下可能無法使用這種方法，例如，必須從某個查詢中取得結果並在下一個查詢使用此結果時。
- **如果查詢會利用相對靜態的參考資料 (例如，郵遞區號資料表或產品清單)，請考慮將此資料複寫到所有分割區，以減少在不同分割區中個別查閱作業的需求**。這種方法也會減少參考資料成為「熱門」資料集的可能性，其受限於整個系統中的高流量。不過，還是會有與同步處理此參考資料的可能發生的任何變更相關聯的其他成本。
- **盡可能最小化跨垂直和功能分割區之參考完整性的需求**。在這些配置中，應用程式本身會負責在更新和取用資料時維護跨分割區的參考完整性。必須跨多個分割區聯結資料的查詢執行速度遠低於只在相同分割區內聯結資料的查詢，因為應用程式通常必須先根據索引鍵，接著根據外部索引鍵來執行連續查詢。請改為考慮將相關資料複寫或取消正規化。為了將必須跨分割區聯結的查詢時間降至最低，請在分割區之間執行平行查詢，並在應用程式內聯結資料。
- **請考慮資料分割配置可能會對跨分割區的資料一致性產生的效果。** 評估強式一致性是否為實際的需求。相反地，雲端中的常見方法是實作最終一致性。每個分割區中的資料會個別更新，而應用程式邏輯可確保所有更新都會順利完成。它也會在執行最終一致性作業時，處理查詢資料所引發的不一致性。如需實作最終一致性的詳細資訊，請參閱 [Data consistency primer (資料一致性入門)]。
- **請考慮查詢如何尋找正確的分割區**。如果查詢必須掃描所有分割區來尋找所需的資料，即使是使用多個平行查詢，還是會對效能產生嚴重的影響。搭配垂直和功能資料分割策略使用的查詢可以自然能夠指定分割區。不過，水平資料分割 (分區化) 會使得尋找項目變得困難，因為每個分區都有相同的結構描述。典型的分區化解決方案是維護對應，用來查閱特定資料項目的分區位置。此對應會在應用程式的分區化邏輯中實作，或者如果它支援透明的分區化，就會由資料存放區維護。
- **使用水平資料分割策略時，請考慮定期重新平衡分區**。這有助於根據大小和工作負載來平均分佈資料，進而最小化作用點、最大化查詢效能，並解決實體的儲存體限制。不過，這是一個複雜的工作，通常需要使用自訂工具或程序。
- **如果您複寫每個分割區，就能提供額外的保護以防止發生錯誤**。如果單一複本失敗，查詢可以導向至可用的複本。
- **如果您達到資料分割策略的實體限制，您可能必須將延展性擴充至不同層級**。例如，如果資料分割是在資料庫層級，可能表示您需要尋找或複寫多個資料庫中的分割區。如果資料分割已經在資料庫層級，而且發生實體限制的問題，可能表示您需要尋找或複寫多個裝載帳戶中的分割區。
- **避免在多個分割區中存取資料的交易**。某些資料存放區會為了修改資料的作業而實作交易一致性和完整性，但唯有當資料位於單一分割區時才如此。如果您需要跨多個分割區的交易式支援，您可能必須實作此支援做為應用程式邏輯的一部分，因為大部分的資料分割系統不會提供原生支援。

所有資料存放區都需要某些作業管理和監視活動。工作的範圍可包含載入資料、備份和還原資料、重新組織資料，以及確保系統正確、有效率地執行。

請考慮下列會影響作業管理的因素：

- **對分割資料時，如何實作適當的管理和操作工作**。這些工作可能包括備份與還原、封存資料、監視系統，以及其他管理工作。例如，在備份和還原作業期間維護邏輯一致性是一項挑戰。
- **如何將資料載入多個分割區，並新增從其他來源送達的新資料**。某些工具和公用程式可能不支援分區化資料作業，例如，將資料載入正確的分割區。這表示，您可能必須建立或取得新的工具和公用程式。
- **如何定期封存及刪除資料**。若要防止分割區過度成長，您必須定期 (也許是每月) 封存及刪除資料。可能需要轉換資料，以符合不同的封存結構描述。
- **如何找出資料完整性問題**。請考慮定期執行程序以尋找任何資料完整性問題，例如，某一個分割區中的資料會參考另一個分割區中遺失的資訊。此程序可嘗試自動修正這些問題，或向操作人員引發警示以手動修正問題。例如，在電子商務應用程式中，訂單資訊可能保留於某一個分割區中，但是構成每張訂單的行項目可能保留於另一個。下單程序必須將資料新增到其他分割區。如果此程序失敗，就會儲存沒有對應訂單的行項目。

不同的資料儲存技術通常會提供自己的功能以支援資料分割。下列各節將扼要說明 Azure 應用程式常用之資料存放區所實作的選項。它們也會描述設計可以善用這些功能之應用程式的考量。

## Azure SQL Database 的資料分割策略。

Azure SQL Database 是在雲端中執行的關聯式資料庫即服務。它是以 Microsoft SQL Server 為基礎。關聯式資料庫會將資訊區分為資料表，而且每個資料表會保留以實體做為一系列資料列的相關資訊。每個資料列包含的資料行都會為實體的個別欄位保留資料。Microsoft 網站上的[什麼是 Azure SQL Database？] 頁面會提供建立及使用 SQL 資料庫的詳細文件。

## 利用彈性資料庫的水平資料分割

單一 SQL 資料庫會對其可包含的資料量有所限制。輸送量會受到結構性因素和其支援之並行連接數目的限制。SQL Database 的彈性資料庫功能支援 SQL 資料庫的水平調整。使用彈性資料庫，您可以將資料分割成分區，以分佈到多個 SQL 資料庫。您也可以因為需要處理的資料量成長和縮減而新增或移除分區。使用彈性資料庫也可以藉由將負載分散到多個資料庫，協助減少爭用。

> [AZURE.NOTE] 彈性資料庫至 2015 年 12 月前為預覽狀態。它是將淘汰的 Azure SQL Database 同盟的替代品。現有的 SQL Database 同盟安裝可以使用 [Federations Migration Utility (同盟移轉公用程式)] 移轉至彈性資料庫。或者，如果您的案例本身無法適用彈性資料庫提供的功能，您可以實作自己的分區化機制。

每個分區都會實作為 SQL 資料庫。一個分區可以保留多個資料集 (稱為 _shardlet_)。每個資料庫會維護描述其所包含之 shardlet 的中繼資料。shardlet 可以是單一資料項目，或一組共用相同 shardlet 索引鍵的項目。例如，如果您在多租用戶應用程式中分區化資料，shardlet 索引鍵可能是租用戶識別碼，而給定租用戶的所有資料都會保留做為相同 shardlet 的一部分。其他租用戶的資料會保留在不同的 shardlet。

設計人員的責任是建立資料集和 shardlet 索引鍵之間的關聯。個別的 SQL 資料庫會用來做為全域分區對應管理員，其中包含由整個系統和每個資料庫中 shardlet 的相關資訊所組成的資料庫 (分區) 清單。存取資料的用戶端應用程式會先連接至全域分區對應管理員資料庫，以取得其接著會在本機快取的分區對應複本 (列出分區和 shardlet)。

應用程式會接著使用這項資訊，將資料要求路由傳送至適當的分區。此功能隱藏在一系列 API (包含在 Azure SQL Database 彈性資料庫用戶端程式庫中) 之後，可做為 NuGet 封裝使用。Microsoft 網站上的[彈性資料庫功能概觀]頁面提供更全面性的彈性資料庫介紹。

> [AZURE.NOTE] 您可以複寫全域分區對應管理員資料庫，以減少延遲並改善可用性。如果您使用其中一個高階定價層來實作資料庫，您可以設定作用中的異地複寫，持續將資料複製到不同區域中的資料庫。在使用者以其為基礎的每個區域中，建立資料庫的複本。然後設定您的應用程式以連接到這個複本，以取得此分區對應。

> 替代方法是使用 Azure SQL 資料同步或 Azure Data Factory 管線，跨區域複寫分區對應管理員資料庫。這種形式的複寫會定期執行，如果分區對應不常變更就更適合。此外，分區對應管理員資料庫不一定要使用高階定價層來建立。

彈性資料庫提供將資料對應到 shardlet 並將它們儲存在分區中的兩個配置：

- **清單分區對應**描述單一索引鍵和 shardlet 之間的關聯。例如，在多租用戶系統中，每個租用戶的資料可以和唯一的索引鍵相關聯，並儲存在自己的 shardlet 中。若要保證隱私權和隔離 (也就是防止某一個租用戶耗盡其他租用戶可使用的資料儲存體資源)，每個 shardlet 都可以保留在自己的分區內。

![使用清單分區對應來將租用戶資料儲存在個別分區中](media/best-practices-data-partitioning/PointShardlet.png)

_圖 4.使用清單分區對應來將租用戶資料儲存在個別分區中_

- **範圍分區對應**描述一組連續索引鍵值和 shardlet 之間的關聯。在先前所述的多租用戶範例中，有個實作專用 shardlet 的替代方案，就是您可以將資料分組成相同 shardlet 之內的一組租用戶 (各有自己的索引鍵)。此配置的成本低於第一個配置 (因為租用戶會共用資料儲存體資源)，但它也會產生資料隱私權和隔離降低的風險。

![使用範圍分區對應來儲存分區中租用戶範圍的資料](media/best-practices-data-partitioning/RangeShardlet.png)

_圖 5.使用範圍分區對應來儲存分區中租用戶範圍的資料_

請注意，單一分區可以包含數個 shardlet 的資料。例如，您可以使用清單 shardlet，將不同非連續租用戶的資料儲存在相同的分區中。您也可以混合相同分區中的範圍 shardlet 和清單 shardlet，雖然它們會透過全域分區對應管理員資料庫中的不同對應來處理(全域分區對應管理員資料庫可以包含多個分區對應)。 圖 6 說名這種方法。

![實作多個分區對應](media/best-practices-data-partitioning/MultipleShardMaps.png)

_圖 6.實作多個分區對應_

您實作的資料分割配置和系統效能有明確的關聯。它也會影響必須新增或移除分區的速率，或者必須跨分區重新分割資料的比率。使用彈性資料庫分割資料時，請考慮下列幾點：

- 將一起使用的資料群組到同一個分區，並避免必須存取保留在多個分區之資料的作業。請記住，有了彈性資料庫，分區本身就是 SQL 資料庫，而 Azure SQL Database 不支援跨資料庫聯結 (其必須在用戶端上執行)。也請記住，在 Azure SQL Database 中，某一個資料庫中的參考完整性條件約束、觸發程序及預存程序都無法參考另一個資料庫中的物件。因此，請不要設計在分區之間具有相依性的系統。不過，SQL 資料庫可包含資料表 (保留查詢和其他作業常用的參考資料副本)。這些資料表不一定要屬於任何特定的 shardlet。跨分區複寫此資料有助於移除聯結跨越資料庫之資料的需要。在理想的情況下，這類資料應該是靜態或緩慢移動的，才能最小化複寫工作量並降低它陳舊的機會。

	> [AZURE.NOTE] 雖然 SQL Database 不支援跨資料庫聯結，但彈性資料庫 API 可讓您執行跨分區查詢。您可以透過分區對應參考的所有 shardlet 中保留的資料，明確地逐一取得這些查詢。彈性資料庫 API 會將跨分區查詢細分為一連串的個別查詢 (每個資料庫一個)，然後合併結果。如需詳細資訊，請參閱 Microsoft 網站上的[多分區查詢]頁面。

- 儲存在屬於 相同分區對應之 shardlet 中的資料應該具有相同的結構描述。例如，建立的清單分區對應不會指向包含租用戶資料的某些 shardlet 和其他包含產品資訊的 shardlet。此規則不會由彈性資料庫強制執行，但如果每個 shardlet 都具有不同的結構描述，資料管理和查詢會變得非常複雜。在剛才提及的範例中，有個不錯的解決方案是建立兩個清單分區對應︰一個參考租用戶資料，另一個則指向產品資訊。請記住，屬於不同 shardlet 的資料可以儲存在相同的分區中。

	> [AZURE.NOTE] 彈性資料庫 API 的跨分區查詢功能取決於包含相同結構描述之分區對應中的每個 shardlet。

- 只有保留在同一個分區內的資料支援交易式作業，跨分區並不支援。交易可以跨越 shardlet，只要它們是相同分區的一部分。因此，如果您的商務邏輯需要執行交易，請將受影響的資料儲存在相同的分區，或實作最終一致性。如需詳細資訊，請參閱 [Data consistency primer (資料一致性入門)]。
- 將分區放在要存取這些分區 (換句話說，就是異地尋找分區) 中之資料的使用者附近。此策略有助於減少延遲。
- 避免混合高度作用中 (作用點) 和相對非使用中的分區。請嘗試跨分區平均分散負載。這可能需要為 shardlet 索引鍵設定雜湊。
- 如果您是地理尋找分區，請確定雜湊索引鍵對應的 shardlet 保留在分區中 (這些分區儲存在存取該資料的使用者附近)。
- 目前，只有部分的 SQL 資料類型集支援做為 shardlet 索引鍵；_int、bigint、varbinary_ 和 _uniqueidentifier_。SQL _int_ 和 _bigint_ 類型對應到 C# 中的 _int_ 和 _long_ 資料類型，而且具有相同的範圍。SQL _varbinary_ 類型可以使用 C# 中的_位元組_陣列處理，而 SQL _uniqueidentier_ 類型會對應到 .NET Framework 中的 _Guid_ 類別。

正如其名，彈性資料庫可在資料數量縮小和成長時，讓系統新增及移除分區。Azure SQL Database 彈性資料庫用戶端程式庫中的 API，會讓應用程式以動態方式建立和刪除分區 (並明確地更新分區對應管理員)。但是，移除分區是破壞性作業，也需要刪除該分區中的所有資料。

如果應用程式必須將一個分區劃分成兩個個別的分區，或將分區結合在一起，彈性資料庫可提供個別的劃分-合併服務。此服務會在雲端託管服務 (必須由開發人員建立) 中執行，並在分區之間安全地移轉資料。如需詳細資訊，請參閱 Microsoft 網站上的[使用彈性資料庫劃分合併工具進行調整]主題。

## Azure 儲存體的資料分割策略

Azure 儲存體提供管理資料的三個抽象概念：

- 表格儲存體，實作可調整的結構儲存體。資料表包含實體集合，每一個集合都可包含一組屬性和值。
- Blob 儲存體，提供大型物件和檔案的儲存體。
- 儲存體佇列，支援應用程式之間可靠的非同步傳訊。

表格儲存體和 Blob 儲存體基本上是索引鍵-值存放區，可最佳化以分別保留結構化和非結構化資料。儲存體佇列提供用來建置鬆散結合且可調整之應用程式的機制。表格儲存體、Blob 儲存體和儲存體佇列會建立在 Azure 儲存體帳戶的內容中。儲存體帳戶支援三種形式的備援：

- **本地備援儲存體**，可在單一資料中心內維護三個資料複本。這種形式的備援可防止硬體錯誤，但無法防止涉及整個資料中心的災害。
- **區域備援儲存體**，可維護同一個區域內三個跨不同資料中心 (或跨兩個地理位置相近的區域) 散佈的資料複本。這種形式的備援可以防止在單一資料中心內發生的災害，但無法防止會影響整個區域的大規模網路中斷連線。請注意，區域備援儲存體目前僅適用於區塊 Blob。
- **異地備援儲存體**，可維護六個資料複本：一個區域中 (您的所在地區) 的三個複本，以及一個遠端區域中的另外三個複本。這種形式的備援提供最高層級的災害防護。

Microsoft 已發佈 Azure 儲存體帳戶的延展性目標。如需詳細資訊，請參閱 Microsoft 網站上的 [Azure 儲存體延展性和效能目標]。總儲存體帳戶容量目前不能超過 500 TB(這包含保留在表格儲存體和 Blob 儲存體中的資料大小，以及保留在儲存體佇列中未處理訊息的大小)。

要求速率上限 (假設為 1 KB 的實體、Blob 或訊息大小) 是每秒 20 KBps。如果您的系統可能會超過這些限制，請考慮跨多個儲存體帳戶分割負載。單一 Azure 訂用帳戶可以建立高達 100 個儲存體帳戶。不過，請注意這些限制可能會隨著時間變更。

## 分割 Azure 表格儲存體

Azure 表格儲存體是一個索引鍵-值存放區，專為資料分割而設計。所有實體都會儲存在分割區中，而且分割區會在內部由 Azure 表格儲存體管理。儲存在資料表中的每個實體都必須提供兩個部分的索引鍵，其中包括：

- **分割區索引鍵**。此為字串值，可決定 Azure 表格儲存體將在哪個分割區中放置實體。具有相同資料分割 索引鍵的所有實體將會儲存在相同分割區上。
- **資料列索引鍵**。這是另一個字串值，會識別分割區內的實體。在一個分割區內的所有實體都會由此索引鍵依照語彙以遞增順序排列。分割區索引鍵/資料列索引鍵組合對每個實體必須是唯一的，且長度不能超過 1 KB。

實體資料的其餘部分由應用程式定義的欄位組成。沒有特定的結構描述會強制執行，而且每個資料列可以包含一組不同的應用程式定義欄位。唯一的限制是實體的大小上限 (包括分割區和資料列索引鍵) 目前為 1 MB。資料表的大小上限為 200 TB，不過這些數字未來可能會變更(請查看 Microsoft 網站上的 [Azure 儲存體延展性和效能目標]頁面，以取得這些限制的最新資訊)。

如果您嘗試儲存的實體超過這個容量，請考慮將它們劃分成多個資料表。使用垂直資料分割，將欄位區分成最有可能一起存取的群組。

圖 7 顯示虛構電子商務應用程式之範例儲存體帳戶 (Contoso 資料) 的邏輯結構。儲存體帳戶包含三個表格：Customer Info、Product Info 和 Order Info。每個資料表有多個分割區。

在 Customer Info 資料表中，資料是依據客戶所在的城市進行分割，而資料列索引鍵包含客戶識別碼。在 Product Info 資料表中，產品是依據產品類別進行分割，而資料列索引鍵包含產品號碼。在 Order Info 資料表中，訂單是依據下單的日期進行分割，而資料列索引鍵會指定收到訂單的時間。請注意，所有資料都會依據資料列索引鍵在每個分割區中排序。

![範例儲存體帳戶中的表格和分割區](media/best-practices-data-partitioning/TableStorage.png)

_圖 7.範例儲存體帳戶中的表格和分割區_

> [AZURE.NOTE] Azure 資料表儲存體也會將時間戳記欄位加入至每個實體。時間戳記欄位由資料表儲存體維護，而且會在每次修改實體並寫回分割區時更新。表格儲存體服務會使用此欄位來實作開放式並行存取 (每次應用程式將實體寫回表格儲存體時，表格儲存體服務會比較正在寫入之實體中的時間戳記值以及保留於表格儲存體中的值。如果這兩個值不同，就表示另一個應用程式在上次擷取實體之後應該已修改該實體，但寫入作業失敗。請勿以您自己的程式碼修改此欄位，也不要在建立新實體時指定此欄位的值。

Azure 資料表儲存體使用資料分割索引鍵來決定如何儲存資料。如果實體已利用先前未使用的分割區索引鍵新增至表格，Azure 表格儲存體就會為此實體建立新的分割區。具有相同資料分割索引鍵的其他實體將會儲存在相同分割區中。

這項機制會有效地實作自動化的向外延展策略。每個分割區都會儲存在 Azure 資料中心的單一伺服器上，以協助確保從單一分割區擷取資料的查詢可以快速執行。但是，不同的分割區可分散於多部伺服器上。此外，如果這些分割區的大小受限，單一伺服器可以裝載多個分割區。

當您設計 Azure 表格儲存體的實體時，請考慮下列幾點：

- 驅動選取資料分割索引鍵與資料列索引鍵值的方法應該和存取資料的方法一致。請選擇分割區索引鍵/資料列索引鍵組合，以支援大多數的查詢。最有效率的查詢會藉由指定分割區索引鍵和資料列索引鍵來擷取資料。掃描單一分割區，即可完成指定分割區索引鍵和資料列索引鍵範圍的查詢。這是相對快速的方法，因為資料會以資料列索引鍵的順序保留。如果查詢未指定要掃描的分割區，則分割區索引鍵可能會要求 Azure 表格儲存體掃描資料的每個分割區。

	> [AZURE.TIP] 如果實體有一個自然索引鍵，則使用它做為資料分割索引鍵，並指定空白字串做為資料列索引鍵。如果實體具有包含兩個屬性的複合索引鍵，選取最慢的變更中屬性做為資料分割索引鍵，另一個則做為資料列索引鍵。如果實體有兩個以上的索引鍵屬性，使用屬性的串連來提供資料分割和資料列索引鍵。

- 如果您使用分割區和資料列索引鍵以外的欄位定期執行查閱資料的查詢，請考慮實作 [Index Table Pattern (索引資料表模式)]。
- 如果您使用單純遞增或遞減數列 (例如 "0001"、"0002"、"0003"，依此類推) 來產生分割區索引鍵，而每個分割區只包含有限的資料數量，那麼 Azure 表格儲存體會在同一部伺服器上將這些分割區實際群組在一起。這個機制假設應用程式很有可能在連續範圍的分割區中執行查詢 (範圍查詢)，並已針對此情況進行最佳化。不過，這種方法會導致著重於單一伺服器的作用點，因為新實體的所有插入可能都會集中在連續範圍的其中一端。它也會降低延展性。若要跨伺服器更平均分佈負載，請考慮雜湊資料分割索引鍵，使順序更加隨機。
- Azure 資料表儲存體支援屬於相同分割區之實體的交易式作業。這表示應用程式可以執行多個插入、更新、刪除、取代或合併作業做為不可部分完成的單位 (前提是交易未包含 100 個以上的實體，且要求的承載大小未超過 4 MB)。跨越多個分割區的作業不是交易式，而且可能需要您實作最終一致性，如同 [Data consistency primer (資料一致性入門)] 所述。如需表格儲存體和交易的詳細資訊，請瀏覽 Microsoft 網站上的[執行實體群組交易]頁面。
- 請特別注意分割區索引鍵的細微性，原因入下：
	- 對每個實體使用相同的分割區索引鍵，會使表格儲存體服務建立保留在某一部伺服器上的單一大型分割區。這可防止它相應放大，並改為將焦點放在單一伺服器上的負載。如此一來，這個方法只適用於管理少數實體的系統。不過，這個方法確實能確保所有實體都可以參與實體群組交易。
	- 對每個實體使用唯一的分割區索引鍵，會導致表格儲存體服務為每個實體建立個別的分割區，可能會產生大量的小型分割區 (取決於實體的大小)。比起使用單一分割區索引鍵，這種方法具更大的可調整性，但無法進行實體群組交易，此外，擷取多個實體的查詢可能牽涉到讀取多部伺服器。不過，如果應用程式執行範圍查詢，使用單純的數列來產生分割區索引鍵可能有助於最佳化這些查詢。
	- 跨實體的子集共用資料分割索引鍵可讓您將相同分割區中的相關實體分組。涉及可使用實體群組交易執行之相關實體的作業，以及擷取一組相關實體的查詢，可藉由存取單一伺服器來滿足。

如需 Azure 表格儲存體中資料分割的詳細資訊，請參閱 Microsoft 網站上的 [Azure 儲存體表格設計指南]一文。

## 分割 Azure blob 儲存體

Azure Blob 儲存體能夠保留大型二進位物件，目前可保留大小高達 200 GB 的區塊 Blob 或 1 TB 的分頁 Blob(如需最新資訊，請參閱 Microsoft 網站上的 [Azure 儲存體延展性和效能目標]頁面)。 在案例中使用區塊 blob，例如您必須在其中快速上傳或下載大量資料的資料流。對需要隨機而不是序列存取部分資料的應用程式使用分頁 blob。

每個 blob (區塊或分頁) 會保留在 Azure 儲存體帳戶中的容器中。您可以使用容器來將具有相同安全性需求的相關 Blob 群組在一起，儘管這個群組是邏輯性，而非實體的。在容器內，每個 Blob 都有唯一的名稱。

Blob 儲存體會根據 blob 名稱自動分割。每個 Blob 會保留在自己的分割區中。相同容器中的 Blob 不會共用分割區。此架構可讓 Azure Blob 儲存體明確地跨伺服器平衡負載，因為相同容器中的不同 Blob 可跨不同的伺服器分佈。

寫入單一區塊 (區塊 blob) 或分頁 (分頁 blob) 的動作是不可部分完成的，但跨越區塊、分頁或 blob 的作業卻不是。如果您必須在跨區塊、分頁和 Blob 執行寫入作業時確保一致性，請使用 Blob 租用來執行寫入鎖定。

Azure Blob 儲存體支援高達每秒 60 MB 的傳輸速率或每個 Blob 每秒 500 個要求。如果您預期會超過這些限制，而且 Blob 資料相對靜態，則考慮使用 Azure 內容傳遞網路來複寫 Blob。如需詳細資訊，請參閱 Microsoft 網站上的[使用 Azure 的內容傳遞網路] 頁面。如需其他指引和考量，請參閱[使用 Azure 的內容傳遞網路]。

## 分割 Azure 儲存體佇列

Azure 儲存體佇列可讓您實作程序之間的非同步傳訊。Azure 儲存體帳戶可以包含任意數目的佇列，而每個佇列可以包含任意數目的訊息。唯一的限制是儲存體帳戶中的可用空間。個別訊息的大小上限是 64 KB。如果您需要比這個限制更大的訊息，請考慮改用 Azure 服務匯流排佇列。

每個儲存體佇列在其所屬的儲存體帳戶內都有唯一的名稱。Azure 會根據名稱分割佇列。同一個佇列的所有訊息都會儲存在相同的分割區中，由單一伺服器所控制。不同的佇列可以由不同的伺服器管理，以協助平衡負載。伺服器的佇列配置對應用程式和使用者而言是透明的。

 在大型應用程式中，請勿將相同的儲存體佇列用於應用程式的所有執行個體，因為這種方法可能會使裝載佇列的伺服器變成作用點。請改為針對應用程式的不同功能區域使用不同的佇列。Azure 儲存體佇列不支援交易，因此將訊息導向到不同的佇列，對傳訊一致性的影響應該不大。

Azure 儲存體佇列每秒可處理高達 2000 個訊息。如果您必須以更高的速率處理訊息，請考慮建立多個佇列。例如，在全域應用程式的個別儲存體帳戶中建立個別儲存體佇列，以處理在每個區域中執行的應用程式執行個體。

## Azure 服務匯流排的資料分割策略

Azure 服務匯流排使用訊息代理程式，來處理傳送至服務匯流排佇列或主題的訊息。根據預設，所有傳送至佇列或主題的訊息都是由相同的訊息代理程式程序來處理。此架構可限制訊息佇列的整體輸送量。不過，您也可以在建立佇列或主題時進行分割。您可以設定將佇列或主題描述的 _EnablePartitioning_ 屬性設定為 _true_，藉以進行分割。

分割的佇列或主題會區分成多個片段，每個片段都會受到個別訊息存放區和訊息代理程式所支援。服務匯流排會負責建立和管理這些片段。當應用程式張貼訊息至分割的佇列或主題時，服務匯流排會將訊息指派給該佇列或主題的片段。當應用程式從佇列或訂用帳戶接收到訊息時，服務匯流排會檢查每個片段是否有下一個可用的訊息，然後將它傳遞給應用程式進行處理。

這種結構有助於跨訊息代理程式和訊息存放區分佈負載，提高延展性並改善可用性。如果有一個片段的訊息代理程式或訊息存放區暫時無法使用，服務匯流排可以從其中一個剩餘的可用片段擷取訊息。

服務匯流排會指派訊息給片段，如下所示：

- 如果訊息屬於工作階段，所有具有 \_ SessionId\_ 屬性之相同值的訊息都會傳送至相同的片段。
- 如果訊息不屬於工作階段，但寄件者已指定 _PartitionKey_ 屬性的值，則具有相同 _PartitionKey_ 值的所有訊息都會傳送至相同的片段。

	> [AZURE.NOTE] 如果同時指定 _SessionId_ 和 _PartitionKey_ 屬性，則必須將它們設為相同的值，否則訊息將會遭到拒絕。
- 如果未指定訊息的 _SessionId_ 和 _PartitionKey_ 屬性，但已啟用重複偵測，就會使用 _MessageId_ 屬性。具有相同 _MessageId_ 的所有訊息會導向至相同的片段。
- 如果訊息不包含 _SessionId、PartitionKey_ 或 _MessageId_ 屬性，則服務匯流排會循序將訊息指派給片段。如果片段無法使用，服務匯流排會移至下一個片段。這表示，傳訊基礎結構中的暫時性錯誤不會造成訊息傳送作業失敗。

在決定是否或如何分割服務匯流排訊息佇列或主題時，請考慮下列幾點：

- 服務匯流排佇列和主題都會在服務匯流排命名空間的範圍內建立。服務匯流排目前每個命名空間允許最多 100 個分割佇列或主題。
- 每個服務匯流排命名空間都會制定可用資源的配額，例如，每個主題的訂用帳戶數目、每秒同時傳送和接收要求的數目，以及可建立之並行連接的最大數目。這些配額會記錄在 Microsoft 網站上的[服務匯流排配額]頁面上。如果您預期超過這些值，請建立其他具有佇列和主題的命名空間，並跨這些命名空間分佈工作。例如，在全域應用程式中的每個區域建立不同的命名空間，並設定應用程式執行個體使用最接近命名空間中的佇列和主題。
- 傳送做為交易一部分的訊息必須指定資料分割索引鍵。這可以是 _SessionId、PartitionKey_ 或 _MessageId_ 屬性。傳送做為相同交易一部分的所有訊息必須指定相同的資料分割索引鍵，因為它們必須由相同的訊息代理程式程序加以處理。您無法在相同的交易內傳送訊息至不同的佇列或主題。
- 無法將分割的佇列或主題設定為在其變成閒置狀態時自動刪除。
- 如果您正在建置跨平台或混合式解決方案，目前無法將分割的佇列和主題與進階訊息佇列通訊協定 (AMQP) 搭配使用。

## Azure DocumentDB 的資料分割策略

Azure DocumentDB 是一種可以儲存文件的 NoSQL 資料庫。DocumentDB 中的文件是物件或其他資料片段的 JSON 序列化表示。沒有固定的結構描述會強制執行，但是每個文件都必須包含唯一識別碼。

文件會組織成集合。集合可讓您將相關文件分組在一起。例如，在維護部落格文章的系統中，您可以將每篇部落格文章的內容儲存為集合中的文件。您也可以為每個主體類型建立集合。或者，在多租用戶應用程式中 (例如可讓不同作者控制和管理自己部落格文章的系統)，您可以根據作者分割部落格，並為每位作者建立個別的集合。配置給集合的儲存體空間非常有彈性，而且可以依需要縮小或成長。

文件集合會提供自然的機制，可在單一資料庫內分割資料。在內部，DocumentDB 資料庫可以跨越多部伺服器，而且可能會嘗試跨伺服器分佈集合以分散負載。實作分區化最簡單的方法是建立每個分區的集合。

> [AZURE.NOTE] 每個 DocumentDB 都有「效能層級」，來決定它取得的資源數量。每個效能層級都會與「要求單位」(RU) 速率限制相關聯。RU 速率限制會指定要保留且可供該集合獨佔使用的資源量。集合的成本取決於為該集合選取的效能層級。效能層級 (和 RU 速率限制) 愈高，費用也愈高。您可以使用 Azure 入口網站來調整集合的效能層級。如需詳細資訊，請參閱 Microsoft 網站上的 [DocumentDB 中的效能層級]頁面。

所有資料庫都要建立在 DocumentDB 帳戶的內容中。單一 DocumentDB 帳戶可以包含多個資料庫，而且它會指定要在哪些區域中建立資料庫。每個 DocumentDB 帳戶也會強制執行它自己的存取控制。您可以使用 DocumentDB 帳戶異地尋找靠近需要存取帳戶之使用者的地區 (資料庫內的集合)，並強制執行限制，以便只讓使用者和它們連接。

每個 DocumentDB 帳戶都有配額，可限制其包含的資料庫和集合數目，以及可用的文件儲存體數量。這些限制可能會變更，但會描述在 Microsoft 網站上的 [DocumentDB 限制和配額]頁面上。理論上，如果您實作一個系統，其中所有分區都屬於同一個資料庫，就有可能達到帳戶的儲存體容量限制。

在此情況下，您可能必須建立其他 DocumentDB 帳戶和資料庫，並跨資料庫分佈分區。不過，即使您不太可能達到資料庫的儲存體容量，它還是使用多個資料庫的最佳做法。這是因為每個資料庫都有自己的一組使用者和權限，而您可以使用這項機制，在每個資料庫上隔離集合的存取權。

圖 8 說明 DocumentDB 架構的高階結構。

![DocumentDB 的結構](media/best-practices-data-partitioning/DocumentDBStructure.png)

_圖 8.DocumentDB 的結構_

用戶端應用程式的工作是將要求導向到適當的分區，通常是以定義分區索引鍵的某些資料屬性為基礎，來實作其本身的對應機制。圖 9 顯示兩個 DocumentDB 資料庫，每一個都包含兩個集合做為分區。資料是由租用戶識別碼分區化，並包含特定租用戶的資料。資料庫會建立在個別的 DocumentDB 帳戶中。這些帳戶都會與其帳戶包含資料之租用戶位於相同的區域中。用戶端應用程式中的路由邏輯會使用租用戶識別碼做為分區索引鍵。

![使用 Azure DocumentDB 實作分區化](media/best-practices-data-partitioning/DocumentDBPartitions.png)

_圖 9.使用 Azure DocumentDB 實作分區化_

決定如何利用 DocumentDB 分割資料時，請考慮下列幾點：

- **DocumentDB 資料庫的可用資源受限於 DocumentDB 帳戶的配額限制**。每個資料庫可以保留許多集合 (同樣地，有其限制)，每個集合都和控管該集合 RU 速率限制 (保留的輸送量) 的效能層級相關聯。如需詳細資訊，請瀏覽 Microsoft 網站上的 [DocumentDB 限制與配額]頁面。
- **每份文件都必須有一個屬性，可用來在保留該文件之集合內唯一識別該文件**。這個屬性和定義哪個集合要保留該文件的分區索引鍵不同。集合可以包含大量文件。理論上，它只受限於文件識別碼的最大長度。文件識別碼可多達 255 個字元。
- **針對文件的所有作業都會在交易的內容中執行。DocumentDB 中的交易範圍則是包含該文件的集合。** 如果作業失敗，會復原已執行的工作。當文件受限於某個作業時，所做的任何變更都會受限於快照集層級隔離。例如，如果要建立新文件的要求失敗，此機制可確保另一個同時查詢資料庫的使用者不會看到當時移除的部分文件。
- **DocumentDB 查詢的範圍也只限於集合層級**。單一查詢只能從一個集合擷取資料。如果您必須從多個集合中擷取資料，您必須個別查詢每個集合，並以應用程式代碼合併結果。
- **DocumentDB 支援所有可和文件一起儲存在集合中的可程式化項目**。這些包括預存程序、使用者定義函式和觸發程序 (以 JavaScript 撰寫)。這些項目可以在相同的集合內存取任何文件。此外，這些項目會在環境交易的範圍內執行 (如果是針對文件執行之建立、刪除或取代作業的結果引發了觸發程序)，或啟動新的交易 (如果是明確的用戶端要求結果做為執行的預存程序)。如果可程式化項目中的程式碼擲回例外狀況，交易就會復原。您可以使用預存程序和觸發程序來維護文件之間的完整性和一致性，但這些文件都必須屬於相同的集合。
- **您想要在 DocumentDB 帳戶的資料庫中保留的集合應該不太可能會超過集合的效能層級所定義的輸送量限制**。如需這些限制的說明，請參閱 Microsoft 網站上的[管理 DocumentDB 容量需求]頁面。如果您預期會達到這些限制，請考慮在不同的 DocumentDB 帳戶中跨資料庫劃分集合，以減少每個集合的負載。

## Azure 搜尋服務的資料分割策略

搜尋資料的功能通常是許多 Web 應用程式所提供的主要導覽及探索方法。它讓使用者可以快速根據搜尋準則的組合尋找資源 (例如，電子商務應用程式中的產品)。Azure 搜尋服務提供 web 內容上的全文檢索搜尋功能，並包括預先輸入、根據鄰近符合項目建議查詢，以及多面向導覽等功能。如需這些功能的完整說明，請參閱 Microsoft 網站上的[何謂 Azure 搜尋服務？]頁面。

Azure 搜尋服務會將可搜尋的內容儲存為資料庫中的 JSON 文件。您定義的索引可以在這些文件中指定可搜尋的欄位，並將這些定義提供給 Azure 搜尋服務。當使用者提交搜尋要求時，Azure 搜尋服務會使用適當的索引來尋找符合的項目。

為了減少爭用，Azure 搜尋服務所使用的儲存體可以區分成 1、2、3、4、6 或 12 個分割區，且每個分割區可以複寫高達 6 次。分割區數目乘以複本數目的乘積稱「搜尋單位」(SU)。Azure 搜尋服務的單一執行個體可以包含最多 36 個 SU (具有 12 個分割區的資料庫只支援最多 3 個複本)。

您需要支付配置給服務的每個 SU。當可搜尋的內容數量增加或搜尋要求的速率成長時，您可以將 SU 新增到 Azure 搜尋服務的現有執行個體來處理額外的負載。Azure 搜尋服務本身會跨分割區平均分佈文件。目前不支援任何手動資料分割策略。

每個分割區可以包含最多 1500 萬份文件或佔用 300 GB 的儲存空間 (取兩者中較低者)。您最多可以建立 50 個索引。服務的效能會因文件的複雜性、可用的索引，以及網路延遲的影響而有所不同。雖然我們建議利用您自己的資料來執行效能評比，以取得更精確的輸送量量值，但平均而言，單一複本 (1 SU) 的處理速度應該是每秒 15 個查詢 (QPS)。如需詳細資訊，請參閱 Microsoft 網站上的 [Azure 搜尋服務中的服務限制]頁面。

> [AZURE.NOTE] 您可以將一組有限的資料類型儲存在可搜尋的文件中，包括字串、布林值、數字資料、日期時間資料，以及一些地理資料。如需詳細資料，請參閱 Microsoft 網站上的[支援的資料類型 (Azure 搜尋服務)] 頁面。

針對 Azure 搜尋服務如何分割每個服務執行個體的資料，您的控制權有限。不過，在全域環境中，您能夠藉由使用下列任一策略來分割服務本身，進一步改善效能並減少延遲和爭用：

- 在每個地理區域中，建立 Azure 搜尋服務的執行個體，並確定會將用戶端應用程式導向至最接近的可用執行個體。此策略需要可搜尋內容的任何更新，可跨服務的所有執行個體即時複寫。

- 建立兩層的 Azure 搜尋服務︰
    - 每個區域中的本機服務，包含該區域中的使用者最常存取的資料。使用者可以在此處導向要求 (適用於快速而有限的結果)。
    - 包含所有資料的全域服務。使用者可以在此處導向要求 (適用於較慢但更完整的結果)。

當搜尋的資料中有重大的區域性變化時，最適用這個方法。

## Azure Redis Cache 的資料分割策略

Azure Redis 快取在雲端中提供以 Redis 索引鍵-值資料存放區為基礎的共用快取服務。正如其名，Azure Redis 快取的目的是做為快取解決方案。只能用它來保留暫時性資料，而不是做為永久的資料存放區。如果快取無法使用，使用 Azure Redis 快取的應用程式應該能夠繼續運作。Azure Redis 快取支援主要/次要複寫以提供高可用性，但目前的快取大小上限為 53 GB。如果您需要更多的空間，您必須建立其他快取。如需詳細資訊，請瀏覽 Microsoft 網站上的 [Azure Redis 快取]頁面。

分割 Redis 資料存放區包含跨 Redis 服務的執行個體劃分資料。每個執行個體都會構成單一分割區。Azure Redis Cache 會抽象化外觀背後的 Redis 服務，而不會直接公開它們。實作資料分割的最簡單方式是建立多個 Azure Redis 快取，並將資料分佈於它們之間。

您可以將每個資料項目關聯至指定哪個快取要儲存資料項目的識別碼 (分割區索引鍵)。用戶端應用程式邏輯接著可以使用這個識別碼，將要求路由傳送至適當的分割區。此配置非常簡單，但是如果資料分割配置有所變更 (例如，如果建立了其他 Azure Redis 快取)，則用戶端應用程式可能需要重新設定。

根據 Redis 叢集，原生 Redis (非 Azure Redis Cache) 支援伺服器端資料分割。在這種方法中，您可以使用雜湊機制，跨伺服器平均區分資料。每個 Redis 伺服器會儲存中繼資料 (描述分割區保留的雜湊索引鍵範圍)，也包含哪些雜湊索引鍵位於其他伺服器上的分割區中的相關資訊。

用戶端應用程式只會將要求傳送至任何參與的 Redis 伺服器 (可能是最接近的伺服器)。Redis 伺服器會檢查用戶端要求。如果可以在本機解決，就會執行要求的作業，否則會將要求轉送到適當的伺服器。

此模型會使用 Redis 叢集實作，而且會在 Redis 網站上的 [Redis 叢集教學課程]頁面上提供更詳細的描述。Redis 叢集對用戶端應用程式而言是透明的。其他的 Redis 伺服器可以加入至叢集 (資料可重新分割)，而不需重新設定用戶端。

> [AZURE.IMPORTANT] Azure Redis Cache 目前不支援 Redis 叢集。如果您想要利用 Azure 實作這個方法，您必須將 Redis 安裝在一組 Azure 虛擬機器上並手動設定它們，以實作您自己的 Redis 伺服器。Microsoft 網站上的[在 Azure 中的 CentOS Linux VM 上執行 Redis] 頁面會逐步解說範例，並顯示如何建置和設定做為 Azure VM 執行的 Redis 節點。

Redis 網站上的 [Partitioning: how to split data among multiple Redis instances (資料分割：如何在多個 Redis 執行個體上分割資料)] 頁面會提供更多關於使用 Redis 實作資料分割的資訊。本節的其餘部分假設您正在實作用戶端或 proxy 輔助資料分割。

決定如何利用 Azure Redis 快取來分割資料時，請考慮下列幾點：

- Azure Redis 快取的目的不是做為永久的資料存放區，因此無論您實作任何資料分割配置，您應用程式的程式碼都必須夠從不是快取的位置上擷取資料。
- 經常一起存取的資料應保留於相同的分割區中。Redis 是一個功能強大的索引鍵-值存放區，提供數種高度最佳化的機制以建構資料。這些機制可以是下列其中一項：
    - 簡單字串 (長度高達 512 MB 的二進位資料)
    - 彙總類型，例如清單 (其可做為佇列和堆疊)
    - 集合 (排序和未排序)
    - 雜湊 (可將相關的欄位群組在一起，例如在一個物件中代表欄位的項目)

- 彙總類型可讓您將許多相關的值與同一個索引鍵建立關聯。Redis 索引鍵可識別清單、集合或雜湊，而非它所包含的資料項目。這些類型全都可供 Azure Redis 快取使用，並描述於 Redis 網站上的 [Data types (資料類型)] 頁面。例如，在追蹤客戶所下訂單的部分電子商務系統中，每一位客戶的詳細資料都可儲存於 Redis 雜湊中，使用客戶識別碼做為索引鍵。每個雜湊都可以保留客戶的訂單識別碼集合。個別的 Redis 集合可以保留訂單、重新建構為雜湊，並使用訂單識別碼做為索引鍵。圖 10 顯示此結構。請注意，Redis 不會實作任何形式的參考完整性，所以開發人員必須負責維護客戶和訂單之間的關聯性。

![Redis 儲存體中記錄客戶訂單及其詳細資料的建議結構](media/best-practices-data-partitioning/RedisCustomersandOrders.png)

_圖 10.Redis 儲存體中記錄客戶訂單及其詳細資料的建議結構_

> [AZURE.NOTE] 在 Redis 中，所有索引鍵都是二進位資料值 (例如 Redis 字串)，且最多可包含 512 MB 的資料。理論上，索引鍵幾乎可以包含所有資訊。不過，建議採用一致的索引鍵命名慣例，可描述資料類型並識別實體，但該慣例不可過長。常見的方法是使用 "entity\_type:ID" 形式的索引鍵。例如，您可以使用 "customer:99" 來指出客戶識別碼 99 的索引鍵。

- 您可以將相關的資訊儲存在相同資料庫中的不同彙總以實作垂直資料分割。例如，在電子商務應用程式中，您可以將經常存取的產品相關資訊儲存在某一個 Redis 雜湊中，並將較少使用的詳細資訊儲存在另一個。這兩個雜湊可以使用相同的產品識別碼做為索引鍵的一部分。例如，您可以針對產品資訊使用 "product:_nn_" (其中 _nn_ 是產品識別碼)，而 "product\_details: _nn_" 則適用於詳細資料。此策略有助於減少大多數查詢可能會擷取的資料量。
- 您可以重新分割 Redis 資料存放區，但請記住它是複雜且耗時的工作。Redis 叢集可以自動重新分割資料，但Azure Redis 快取無法使用此功能。因此，當您設計資料分割配置時，請嘗試在每個分割區中保留足夠的可用空間，以允許一段時間後預期的資料成長。不過，請記住 Azure Redis Cache 的目的是暫時快取資料，而且保留在快取中的資料具有有限的存留期，指定為存留時間 (TTL) 值。對於相對易變的資料而言，TTL 可以短一點，但對於靜態資料而言，TTL 可以更長。如果此資料量可能會填滿快取，請避免在快取中儲存大量長時間留存的資料。如果空間價格不斐，您可以指定會讓 Azure Redis Cache 移除資料的收回原則。

	> [AZURE.NOTE] Azure Redis 快取可讓您藉由選取適當的定價層以指定快取的大小上限 (從 250MB 到 53GB)。不過，建立 Azure Redis 快取之後，您就無法增加 (或減少) 其大小。

- Redis 批次與交易無法跨越多個連接，因此受批次或交易影響的所有資料應都保留在相同的資料庫 (分區) 中。

	> [AZURE.NOTE] Redis 交易中的作業序列不一定是不可部分完成的。構成交易的命令已經過驗證，並在執行之前已排入佇列，如果在這個階段期間發生錯誤，即會捨棄整個佇列。不過，在交易成功提交之後，排入佇列的命令就會依序執行。如果有任何命令失敗，則只有該命令會停止執行。佇列中的所有先前與後續命令都會執行。如需詳細資訊，請瀏覽 Redis 網站上的 [Transactions (交易)] 頁面。

- Redis 支援有限數量的不可部分完成作業。支援多個索引鍵和值的此類型作業只有 MGET 和 MSET 作業。MGET 作業會傳回指定索引鍵清單值的集合，而 MSET 作業會儲存指定索引鍵清單值的集合。如果您必須使用這些作業，MSET 和 MGET 命令所參考的索引鍵-值組必須儲存在同一個資料庫內。

## 重新平衡分割區

當系統成熟且您更加了解使用模式時，您可能必須調整資料分割配置。例如，個別的分割區可能開始吸引不當比例的流量並變得熱門，導致過度爭用。此外，您可能低估某些分割區中的資料量，使您達到這些分割區中的儲存體容量限制。無論原因為何，有時候必須重新平衡分割區，才能更平均地分散負載。

在某些情況下，不公開資料配置到伺服器之方式的資料儲存系統，會在可用資源限制內自動重新平衡分割區。在其他情況下，重新平衡是由兩個階段組成的系統管理工作：

1. 判斷新的資料分割策略，以確定：
    - 哪些分割區可能必須劃分 (或可能必須結合)。
    - 如何藉由設計新的分割區索引鍵，將資料配置到這些新的分割區。
2. 將受影響的資料從舊的資料分割配置移轉至一組新的分割區。

> [AZURE.NOTE] DocumentDB 集合到伺服器的對應是透明的，但您仍可能達到 DocumentDB 帳戶的儲存容量與輸送量限制。如果發生這種情況，您可能必須重新設計資料分割配置，並移轉資料。

根據資料儲存技術和您的資料儲存系統設計，您可以在使用分割區時，於分割區之間移轉資料 (線上移轉) 。如果此方法不可行，您可能必須在重新定位資料時讓受影響的分割區暫時無法使用 (離線移轉)。

## 離線移轉

離線移轉可說是最簡單的方法，因為它可以減少發生爭用的機會。在移動與重新建構資料時，請勿變更資料。

就概念而言，此程序包含下列步驟：

1. 將分區標記為離線。
2. 劃分-合併資料，並將其移到新的分區。
3. 驗證資料。
4. 使新的分區上線。
5. 移除舊的分區。

若要保留一些可用性，您可能要在步驟 1 中將原始分區標示為唯讀，而不是使其無法使用。這允許應用程式在資料移動時讀取資料，而不是變更資料。

## 線上移轉

執行線上移轉更複雜，但是使用者比較不受干擾，因為資料在整個程序期間可繼續使用。其程序與離線移轉所使用的程序相似，不同之處在於原始分區未標示為離線 (步驟 1)。根據移轉程序的細微性 (例如，它是否會逐一項目或分區來完成)，用戶端應用程式中的資料存取程式碼必須處理保留在兩個位置 (原始分區和新分區) 中之資料的讀取和寫入。

如需支援線上移轉的解決方案範例，請參閱 Microsoft 網站上的[使用彈性資料庫分割合併工具來縮放]一文。

## 相關的模式和指導方針

考量實作資料一致性的策略時，下列模式可能也會與您的案例相關：

- Microsoft 網站上的 [Data Consistency Primer (資料一致性入門)] 頁面會說明在雲端等分散式環境中維護一致性的策略。
- Microsoft 網站上的 [Data partitioning guidance (資料分割指引)] 頁面提供如何設計分割區以符合分散式解決方案中各種準則的一般概觀。
- Microsoft 網站上所述的 [Sharding Pattern (分區化模式)] 摘要列出一些分區化資料的常見策略。
- Microsoft 網站上所述的 [Index Table Pattern (索引資料表模式)] 說明如何建立資料的次要索引。這個方法可讓應用程式使用未參考集合的主索引鍵的查詢，以快速擷取資料。
- Microsoft 網站上所述的 [Materialized View Pattern (具體化檢視模式)] 說明如何產生預先填入的檢視，可摘要列出資料以支援快速查詢作業。如果包含已摘要列出之資料的分割區已快多個網站分佈，這個方法會對分割的資料存放區很有幫助。
- Microsoft 網站上的[使用 Azure 的內容傳遞網路]一文提供有關設定和使用 內容傳遞網路搭配 Azure 的其他指引。

## 詳細資訊

- Microsoft 網站上的[什麼是 Azure SQL Database？]頁面提供詳細的文件，說明如何建立及使用 SQL 資料庫。
- Microsoft 網站上的[彈性資料庫功能概觀]頁面提供全面性的彈性資料庫介紹。
- Microsoft 網站上的[使用彈性資料庫分割合併工具來縮放]頁面會包含使用劃分-合併服務來管理彈性資料庫分區的相關資訊。
- Microsoft 網站上的 [Azure 儲存體延展性和效能目標](https://msdn.microsoft.com/library/azure/dn249410.aspx)頁面記錄 Azure 儲存體目前的大小和輸送量限制。
- Microsoft 網站上的[執行實體群組交易]頁面提供有關透過儲存在 Azure 表格儲存體的實體實作交易式作業的詳細資訊。
- Microsoft 網站上的 [Azure 儲存體表格設計指南]一文會包含有關 Azure 表格儲存體中的資料分割的詳細資訊。
- Microsoft 網站上的[使用 Azure 的內容傳遞網路]頁面會說明如何使用 Azure 內容傳遞網路來複寫保留在 Azure Blob 儲存體中的資料。
- Microsoft 網站上的[管理 DocumentDB 容量需求]頁面包含 Azure DocumentDB 如何將資源配置到資料庫的相關資訊。
- Microsoft 網站上的[何謂 Azure 搜尋服務？]頁面會提供可在 Azure 搜尋服務使用之功能的完整說明。
- Microsoft 網站上的 [Azure 搜尋中的服務限制]頁面包含 Azure 搜尋服務之每個執行個體的功能相關資訊。
- Microsoft 網站上的[支援的資料類型 (Azure 搜尋服務)] 頁面摘要列出您可以在可搜尋文件和索引中使用的資料類型。
- Microsoft 網站上的 [Azure Redis 快取]頁面提供 Azure Redis 快取的簡介。
- Redis 網站上的 [Partitioning: how to split data among multiple Redis instances (資料分割：如何在多個 Redis 執行個體上劃分資料)] 頁面提供如何使用 Redis 實作資料分割的相關資訊。
- Microsoft 網站上的[在 Azure 中的 CentOS Linux VM 上執行 Redis] 頁面會逐步解說範例，並顯示如何建置和設定做為 Azure VM 執行的 Redis 節點。
- Redis 網站上的 [Data Types (資料類型)] 頁面描述 Redis 和 Azure Redis 快取皆可使用的資料類型。

[Azure Redis 快取]: http://azure.microsoft.com/services/cache/
[Azure 儲存體延展性和效能目標]: storage/storage-scalability-targets.md
[Azure 儲存體表格設計指南]: storage/storage-table-design-guide.md
[Building a polyglot solution (建置 Polyglot 解決方案)]: https://msdn.microsoft.com/library/dn313279.aspx
[Data Access for Highly-Scalable Solutions: Using SQL, NoSQL, and Polyglot Persistence (高度可調整解決方案的資料存取：使用 SQL、NoSQL 和 Polyglot 持續性)]: https://msdn.microsoft.com/library/dn271399.aspx
[Data consistency primer (資料一致性入門)]: http://aka.ms/Data-Consistency-Primer
[Data partitioning guidance (資料分割指引)]: https://msdn.microsoft.com/library/dn589795.aspx
[Data types (資料類型)]: http://redis.io/topics/data-types
[DocumentDB 限制和配額]: documentdb/documentdb-limits.md
[DocumentDB 限制與配額]: documentdb/documentdb-limits.md
[彈性資料庫功能概觀]: sql-database/sql-database-elastic-scale-introduction.md
[Federations Migration Utility (同盟移轉公用程式)]: https://code.msdn.microsoft.com/vstudio/Federations-Migration-ce61e9c1
[Index Table Pattern (索引資料表模式)]: http://aka.ms/Index-Table-Pattern
[管理 DocumentDB 容量需求]: documentdb/documentdb-manage.md
[Materialized View Pattern (具體化檢視模式)]: http://aka.ms/Materialized-View-Pattern
[多分區查詢]: sql-database/sql-database-elastic-scale-multishard-querying.md
[Partitioning: how to split data among multiple Redis instances (資料分割：如何在多個 Redis 執行個體上分割資料)]: http://redis.io/topics/partitioning
[Partitioning: how to split data among multiple Redis instances (資料分割：如何在多個 Redis 執行個體上劃分資料)]: http://redis.io/topics/partitioning
[DocumentDB 中的效能層級]: documentdb/documentdb-performance-levels.md
[執行實體群組交易]: https://msdn.microsoft.com/library/azure/dd894038.aspx
[Redis 叢集教學課程]: http://redis.io/topics/cluster-tutorial
[在 Azure 中的 CentOS Linux VM 上執行 Redis]: http://blogs.msdn.com/b/tconte/archive/2012/06/08/running-redis-on-a-centos-linux-vm-in-windows-azure.aspx
[使用彈性資料庫分割合併工具來縮放]: sql-database/sql-database-elastic-scale-overview-split-and-merge.md
[使用彈性資料庫劃分合併工具進行調整]: sql-database/sql-database-elastic-scale-overview-split-and-merge.md
[使用 Azure 的內容傳遞網路]: cdn/cdn-how-to-use-cdn.md
[服務匯流排配額]: service-bus/service-bus-quotas.md
[Azure 搜尋中的服務限制]: search/search-limits-quotas-capacity.md
[Azure 搜尋服務中的服務限制]: search/search-limits-quotas-capacity.md
[Sharding Pattern (分區化模式)]: http://aka.ms/Sharding-Pattern
[分區化模式]: http://aka.ms/Sharding-Pattern
[支援的資料類型 (Azure 搜尋服務)]: https://msdn.microsoft.com/library/azure/dn798938.aspx
[Transactions (交易)]: http://redis.io/topics/transactions
[何謂 Azure 搜尋服務？]: search/search-what-is-azure-search.md
[什麼是 Azure SQL Database？]: sql-database/sql-database-technical-overview.md

<!---HONumber=AcomDC_0330_2016-->